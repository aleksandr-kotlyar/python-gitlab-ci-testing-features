allure:
  stage: Generate Reports
  image: registry.gitlab.com/aleksandr-kotlyar/python_and_gitlab/java-allure-python:openjdk-14-allure-2.13.6-python-3.7
  when: on_success
  variables:
    PRIVATE_TOKEN: $PRIVATE_TOKEN
  needs:
    - job: chrome:remote
      artifacts: true
  script:
    - mkdir -p ./.public
    - python3 artifacts.py
    - ls .public -la
    - pwd
    - ls public -la
    # copy last-reports/history to /reports
    - LAST=$("cd /public/stage; ls -td -- */ | head -n 1") || echo "Sorry, latest build not found"
    - echo "${LAST}"
    - mkdir -p /public/stage/${CI_JOB_ID}
    - cd ${LAST}; pwd; ls -la; cd ${LAST}history; pwd || echo "Sorry, latest build not found"
    - cd .
    - cp -r ${LAST}history reports/ || echo "Sorry, no reports/history"
    - allure generate reports
    - cp -r allure-report/* /public/stage/${CI_JOB_ID}/
  artifacts:
    paths:
      - public

pages:
  image: python:3.7-alpine
  stage: deploy
  when: on_success
  needs:
    - job: allure
      artifacts: true
  script:
    - python3 generate_index.py
  artifacts:
    paths:
      - public
