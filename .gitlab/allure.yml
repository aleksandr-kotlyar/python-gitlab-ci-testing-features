allure:
  stage: Generate Reports
  image: registry.gitlab.com/aleksandr-kotlyar/python_and_gitlab/java-allure-python:openjdk-14-allure-2.13.6-python-3.7
  when: on_success
  needs:
    - job: chrome:remote
      artifacts: true
  before_script:
    - python3 artifacts.py
    - ls -la
    - pwd
    - ls public/stage -la
    # copy last-reports/history to /reports
    - LAST=$("cd ./public/stage; ls -td -- */ | head -n 1")
    - mkdir -p ./public/stage/${CI_JOB_ID}
    - cd ${LAST}; pwd; ls -la; cd ${LAST}history; pwd;
    - cd .
    - cp -r ${LAST}history reports/ || echo "No history"
    - allure generate reports
    - cp -r allure-report/* ./public/stage/${CI_JOB_ID}/
  script:
    - allure generate reports
  artifacts:
    paths:
      - public

pages:
  image: python:3.7-alpine
  stage: deploy
  when: on_success
  needs:
    - job: allure
      artifacts: true
  script:
    - python3 generate-index.py
  artifacts:
    paths:
      - public
